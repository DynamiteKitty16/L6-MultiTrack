<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MultiTracker{% endblock %}</title>

    <!-- Link to the compiled Tailwind CSS -->
    {% load static %}
    <link href="{% static 'css/output.css' %}" rel="stylesheet">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <header>
        <nav>
            {% if request.path != '/' %}
                <a href="/">Home</a>
            {% endif %}
            {% if user.is_authenticated %}
                <a href="/dashboard/">Dashboard</a>
                <a href="/logout/">Logout</a>
            {% endif %}
        </nav>
    </header>
    <main>
        {% block content %}{% endblock %}
    </main>
    <footer>
        <p>&copy; 2024 MultiTracker</p>
    </footer>

    {% if user.is_authenticated %}
        <script>
            // Session timeout in seconds (set dynamically by Django)
            const sessionTimeout = 900; // 15 minutes in seconds
            const warningTime = sessionTimeout - 60; // Show warning 1 minute before timeout

            // Timer for showing the logout warning
            const warningTimer = setTimeout(() => {
                const stayLoggedIn = confirm(
                    "You will be logged out due to inactivity in 1 minute. Click OK to stay logged in."
                );
                if (stayLoggedIn) {
                    // Make an AJAX call to refresh the session
                    fetch("{% url 'session_timeout_warning' %}", { method: "GET", credentials: "same-origin" })
                        .then(response => {
                            if (response.ok) {
                                alert("Session refreshed successfully!");
                                window.location.reload(); // Reload the page to reset timers
                            } else {
                                alert("Unable to refresh session. Please log back in.");
                            }
                        })
                        .catch(() => alert("Failed to refresh session. Please log back in."));
                }
            }, warningTime * 1000);

            // Timer for automatic logout
            const logoutTimer = setTimeout(() => {
                window.location.href = "{% url 'custom_logout' %}";
            }, sessionTimeout * 1000);
        </script>
    {% endif %}
</body>
</html>
