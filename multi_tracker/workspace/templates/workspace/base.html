<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MultiTracker{% endblock %}</title>

    <!-- Link to the compiled Tailwind CSS -->
    {% load static %}
    <link href="{% static 'css/output.css' %}" rel="stylesheet">

    {% block extra_head %}{% endblock %}
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gray-800 text-white p-4">
        <nav class="container mx-auto flex justify-between items-center">
            <div>
                {% if request.path != '/' %}
                    <a href="/" class="text-gray-300 hover:text-white">Home</a>
                {% endif %}
            </div>
            <div>
                {% if user.is_authenticated %}
                    <a href="/dashboard/" class="text-gray-300 hover:text-white mr-4">Dashboard</a>
                    <a href="/accounts/logout/" class="text-gray-300 hover:text-white">Logout</a>
                {% else %}
                    <a href="/accounts/login/" class="text-gray-300 hover:text-white mr-4">Login</a>
                    <a href="/register/" class="text-gray-300 hover:text-white">Register</a>
                {% endif %}
            </div>
        </nav>
    </header>
    <main class="flex-grow container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>
    <footer class="bg-gray-800 text-white p-4 text-center">
        <p>&copy; 2024 MultiTracker</p>
    </footer>

    <!-- Include timeout handling if the user is authenticated -->
    {% if user.is_authenticated %}
    <!-- Tailwind Session Timeout Modal -->
    <div id="sessionTimeoutModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h5 class="text-lg font-bold mb-4">Session Timeout Warning</h5>
            <p class="mb-6">You have been inactive for a while. You will be logged out soon.</p>
            <div class="flex justify-end">
                <button id="stayLoggedInBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Stay Logged In</button>
            </div>
        </div>
    </div>

    <script>
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }

        function showSessionWarning() {
            // Show the Tailwind modal
            document.getElementById('sessionTimeoutModal').classList.remove('hidden');
        }

        function checkSessionTimeout() {
            fetch('/session_timeout_warning/')
                .then(response => response.json())
                .then(data => {
                    if (data.time_left <= 0) {
                        window.location.href = '/accounts/login/';
                    } else if (data.time_left <= 300) { // Show warning 5 minutes before expiry
                        showSessionWarning();
                    }
                })
                .catch(() => window.location.href = '/accounts/login/');
        }

        // Check session timeout every minute
        setInterval(checkSessionTimeout, 60000);

        // Handle Stay Logged In button click
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stayLoggedInBtn').addEventListener('click', () => {
                fetch('/extend_session/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                    }
                })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('sessionTimeoutModal').classList.add('hidden');
                    } else {
                        throw new Error('Failed to extend session');
                    }
                })
                .catch(() => window.location.href = '/accounts/login/');
            });
        });
    </script>
    {% endif %}
</body>
</html>
